---
title: "Core_UD_AreaGAM"
author: "MThompson"
date: '2022-08-28'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## packages

```{r echo=FALSE}

if(!require(here)){install.packages("here")}
if(!require(mgcv)){install.packages("mgcv")}
if(!require(gratia)){install.packages("gratia")}
if(!require(bbmle)){install.packages("bbmle")}
if(!require(lme4)){install.packages("lme4")}



library(here)
library(mgcv)
library(gratia)
library(bbmle) 
library(lme4)

```

## GAM Season Factor
In this first analysis of the data I treated season as a factor variable, but this is incorrect. It is an ordered variable and can be modeled with GAMs (Jensen et al., 2022; Simpson 2014).

#References
Jensen, S. A., Webb, J. R., Simpson, G. L., Baulch, H. M., Leavitt, P. R., & Finlay, K. (2022). Seasonal variability of CO2, CH4, and N2O content and fluxes in small agricultural reservoirs of the northern Great Plains. Frontiers in Environmental Science, 10. https://doi.org/10.3389/fenvs.2022.895531

Simpson, G.A. Modelling seasonal data with GAMs. Blog: From the bottom of the heap. https://fromthebottomoftheheap.net/2014/05/09/modelling-seasonal-data-with-gam/

```{r GAM, echo=FALSE}

BMTR_sUDs_areas <- read.csv(paste0(here("adeHRoutput_noclip","Seasons"),"/Agg_UD_areasWI.csv"),	stringsAsFactors=FALSE,	na.strings="NA")

##Proceeding through exploratory examples from Zuur et al. (2009):

dotchart(BMTR_sUDs_areas$area, groups= factor(BMTR_sUDs_areas$SA), pch = BMTR_sUDs_areas$SA, ylab = "Study Area", xlab = "Area", main = "Cleveland dotplot")

BMTR_sUDs_areas$SA <- as.factor(BMTR_sUDs_areas$SA)
BMTR_sUDs_areas$season <- as.factor(BMTR_sUDs_areas$season)
BMTR_sUDs_areas$warea <- BMTR_sUDs_areas$area / BMTR_sUDs_areas$nb.reloc
BMTR_sUDs_areas$yearf <- as.factor(BMTR_sUDs_areas$year)
pairs(BMTR_sUDs_areas)

source(paste0(here(),"/HighstatLibV10.R"))

M1 <- lm(warea ~ year, subset = (BMTR_sUDs_areas$SA == "BM"), data = BMTR_sUDs_areas)
op <- par(mfrow = c(2,2))
plot(M1, add.smooth = FALSE)
par(op)

M2 <- lm(warea ~ year, subset = (BMTR_sUDs_areas$SA == "TR"), data = BMTR_sUDs_areas)
op <- par(mfrow = c(2,2))
plot(M2, add.smooth = FALSE)
par(op)

## Non-linear. There is Cooks distance beyond the threshold value of 1 (see Zuur et al. 2009) - needs to be managed. Item 33 in TR is highly problematic - will remove this one:

BMTR_sUDs_areasr <- BMTR_sUDs_areas[c(1:32,34:133),]

TR_sUDs_areasWIr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$SA == "TR" & BMTR_sUDs_areasr$season == "WI"),]
BM_sUDs_areasWIr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$SA == "BM" & BMTR_sUDs_areasr$season == "WI"),]


mean(TR_sUDs_areasWIr$area)
mean(TR_sUDs_areasWIr$warea)
mean(BM_sUDs_areasWIr$area)
mean(BM_sUDs_areasWIr$warea)


BMTR_sUDs_WIr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$season == "WI"),]
BMTR_sUDs_CAr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$season == "CA"),]
BMTR_sUDs_SUr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$season == "SU"),]
BMTR_sUDs_RUr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$season == "RU"),]


```

## GAMs

Plots of core UD areas over time are heterogenous between seasons and between study areas. The question being asked is if there is a difference between TR and BM in the dynamics of area amount by season across years. The prediction is that the winter range will have larger areas where there is more disturbance as this will spread the individuals apart (dispersion) or drive them to move greater distances. Roman and Bullmoose (= SA, Study Area) are modeled as independent factors (i.e., the experimental treatment).

```{r}

# area ~ SA + year + season
GAM1 = gam(warea ~ s(SA, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM2 = gam(warea ~ s(SA, bs = 're') + s(yearf, bs = 're') + s(season, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM3 = gam(warea ~ s(SA, bs = 're') + s(season, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM4 = gam(warea ~ s(SA, bs = 're') + s(yearf, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM5 = gam(warea ~ s(SA, bs = 're') + s(season,yearf, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM6 = gam(warea ~ s(SA,season, bs = 're') +  s(yearf, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM7 = gam(warea ~ s(SA,yearf, bs = 're') + s(season, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM8 = gam(warea ~ SA + s(season, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM9 = gam(warea ~ SA + s(season, yearf, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM10 = gam(warea ~ SA + season + s(yearf, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM11 = gam(warea ~ s(year),
                  data = BMTR_sUDs_areas,
                  method = "REML")

GAM12 = gam(warea ~ s(SA, bs = 're') + s(season, bs = 're') + s(year),
                  data = BMTR_sUDs_areas,
                  method = 'REML')

GAM13 = gam(warea ~ s(SA, bs = 're') + s(year),
                  data = BMTR_sUDs_areas,
                  method = "REML")

GAM14 = gam(warea ~ s(SA, bs = 're') + s(yearf, bs = 're'),
                  data = BMTR_sUDs_areas,
                  method = "REML")



AICtab(GAM1, GAM2, GAM3, GAM4, GAM5,GAM6,GAM7,GAM8,GAM9,GAM10,GAM11,GAM12,GAM13,GAM14)
AIC(GAM1, GAM2, GAM3, GAM4, GAM5,GAM6,GAM7,GAM8,GAM9,GAM10,GAM11,GAM12,GAM13,GAM14)

## outlier removed
# area ~ SA + year + season
GAMr1 = gam(warea ~ s(SA, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr2 = gam(warea ~ s(SA, bs = 're') + s(yearf, bs = 're') + s(season, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr3 = gam(warea ~ s(SA, bs = 're') + s(season, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr4 = gam(warea ~ s(SA, bs = 're') + s(yearf, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr5 = gam(warea ~ s(SA, bs = 're') + s(season,yearf, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr6 = gam(warea ~ s(SA,season, bs = 're') +  s(yearf, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr7 = gam(warea ~ s(SA,yearf, bs = 're') + s(season, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr8 = gam(warea ~ SA + s(season, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr9 = gam(warea ~ SA + s(season, yearf, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr10 = gam(warea ~ SA + season + s(yearf, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr11 = gam(warea ~ s(year),
                  data = BMTR_sUDs_areas,
                  method = "REML")

GAMr12 = gam(warea ~ s(SA, bs = 're') + s(season, bs = 're') + s(year),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')

GAMr13 = gam(warea ~ s(SA, bs = 're') + s(year),
                  data = BMTR_sUDs_areasr,
                  method = "REML")

GAMr14 = gam(warea ~ s(SA, bs = 're') + s(yearf, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = "REML")



AICtab(GAMr1, GAMr2, GAMr3, GAMr4, GAMr5,GAMr6,GAMr7,GAMr8,GAMr10,GAMr11,GAMr12,GAMr13,GAMr14)
AIC(GAMr1, GAMr2, GAMr3, GAMr4, GAMr5,GAMr6,GAMr7,GAMr8,GAMr10,GAMr11,GAMr12,GAMr13,GAMr14)


## outlier removed - Winter only
# area ~ SA + year + season
GAMwr1 = gam(warea ~ s(SA, bs = 're'),
                  data = BMTR_sUDs_WIr,
                  method = 'REML')

GAMwr2 = gam(warea ~ s(SA, bs = 're') + s(yearf, bs = 're'),
                  data = BMTR_sUDs_WIr ,
                  method = 'REML')

GAMwr3 = gam(warea ~ s(SA,yearf, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')



AICtab(GAMwr1, GAMwr2, GAMwr3)
AIC(GAMwr1, GAMwr2, GAMwr3)

## outlier removed - CA only
# area ~ SA + year + season
GAMcr1 = gam(warea ~ s(SA, bs = 're'),
                  data = BMTR_sUDs_CAr,
                  method = 'REML')

GAMcr2 = gam(warea ~ s(SA, bs = 're') + s(yearf, bs = 're'),
                  data = BMTR_sUDs_CAr ,
                  method = 'REML')

GAMcr3 = gam(warea ~ s(SA,yearf, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')



AICtab(GAMcr1, GAMcr2, GAMcr3)
AIC(GAMcr1, GAMcr2, GAMcr3)


## outlier removed - SU only
# area ~ SA + year + season
GAMsr1 = gam(warea ~ s(SA, bs = 're'),
                  data = BMTR_sUDs_SUr,
                  method = 'REML')

GAMsr2 = gam(warea ~ s(SA, bs = 're') + s(yearf, bs = 're'),
                  data = BMTR_sUDs_SUr ,
                  method = 'REML')

GAMsr3 = gam(warea ~ s(SA,yearf, bs = 're'),
                  data = BMTR_sUDs_areasr,
                  method = 'REML')



AICtab(GAMsr1, GAMsr2, GAMsr3)
AIC(GAMsr1, GAMsr2, GAMsr3)

## outlier removed - RU only
# area ~ SA + year + season
GAMrur1 = gam(warea ~ s(SA, bs = 're'),
                  data = BMTR_sUDs_RUr,
                  method = 'REML')

GAMrur2 = gam(warea ~ s(SA, bs = 're') + s(yearf, bs = 're'),
                  data = BMTR_sUDs_RUr ,
                  method = 'REML')

#GAMrur3 = gam(warea ~ s(SA,yearf, bs = 're'),
                  data = BMTR_sUDs_RUr,
                  method = 'REML')


#There are more predictor variables as compared to the number of observations in GAMrur3 - cannot run.

#AICtab(GAMrur1, GAMrur2, GAMrur3)
#AIC(GAMrur1, GAMrur2, GAMrur3)

```

## GAM Season Ordered
Season is analyzed as an ordered variable adapting method of Simpson (2014).

#References

Simpson, G.A. Modelling seasonal data with GAMs. Blog: From the bottom of the heap. https://fromthebottomoftheheap.net/2014/05/09/modelling-seasonal-data-with-gam/

```{r GAM, echo=FALSE}

BMTR_sUDs_areas <- read.csv(paste0(here("adeHRoutput_noclip","Seasons"),"/Agg_UD_areasWI.csv"),	stringsAsFactors=FALSE,	na.strings="NA")

##Proceeding through exploratory examples from Zuur et al. (2009):

dotchart(BMTR_sUDs_areas$area, groups= factor(BMTR_sUDs_areas$SA), pch = BMTR_sUDs_areas$SA, ylab = "Study Area", xlab = "Area", main = "Cleveland dotplot")

BMTR_sUDs_areas$SA <- as.factor(BMTR_sUDs_areas$SA)
BMTR_sUDs_areas$season <- as.factor(BMTR_sUDs_areas$season)
BMTR_sUDs_areas$warea <- BMTR_sUDs_areas$area / BMTR_sUDs_areas$nb.reloc
BMTR_sUDs_areas$yearf <- as.factor(BMTR_sUDs_areas$year)
pairs(BMTR_sUDs_areas)

source(paste0(here(),"/HighstatLibV10.R"))

M1 <- lm(warea ~ year, subset = (BMTR_sUDs_areas$SA == "BM"), data = BMTR_sUDs_areas)
op <- par(mfrow = c(2,2))
plot(M1, add.smooth = FALSE)
par(op)

M2 <- lm(warea ~ year, subset = (BMTR_sUDs_areas$SA == "TR"), data = BMTR_sUDs_areas)
op <- par(mfrow = c(2,2))
plot(M2, add.smooth = FALSE)
par(op)

## Non-linear. There is Cooks distance beyond the threshold value of 1 (see Zuur et al. 2009) - needs to be managed. Item 33 in TR is highly problematic - will remove this one:

BMTR_sUDs_areasr <- BMTR_sUDs_areas[c(1:32,34:133),]

TR_sUDs_areasWIr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$SA == "TR" & BMTR_sUDs_areasr$season == "WI"),]
BM_sUDs_areasWIr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$SA == "BM" & BMTR_sUDs_areasr$season == "WI"),]


mean(TR_sUDs_areasWIr$area)
mean(TR_sUDs_areasWIr$warea)
mean(BM_sUDs_areasWIr$area)
mean(BM_sUDs_areasWIr$warea)


BMTR_sUDs_WIr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$season == "WI"),]
BMTR_sUDs_CAr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$season == "CA"),]
BMTR_sUDs_SUr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$season == "SU"),]
BMTR_sUDs_RUr <- BMTR_sUDs_areasr[which(BMTR_sUDs_areasr$season == "RU"),]


```

